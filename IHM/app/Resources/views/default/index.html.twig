{% extends 'base.html.twig' %}

{% block body %}
    <!DOCTYPE html>
    <html>
    <head>
        <title>Bomberman</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="css/style.css">
        

    </head>
    <body>
    <h1>Bomberman</h1>
    <form>
    <div style="margin: auto;width:30%">
        <div class="form-group" style="margin: auto;width:200px">
            <label>Server address<input class="form-control" style="width:auto" type="textaera" id="servAddress"></label><br>
        </div>
        <div class="form-group" style="margin: auto;width:200px">
            <label>Nombre de joueurs<input class="form-control" style="width:auto" type="number" id="numberPlayers"></label><br>
        </div>
        <div id="players">

        </div>
        <div style="margin:auto;width:140px">
            <input class="btn btn-default" type="button" onClick="request()" value="Lancer le jeu"/>
        </div>
    </div>
    </form>
    <div id="result">-</div>

    <script>
        var players = [];
        var oldPlayers = [];
        var board = [];
        var bombsDropped = 0;
        $('#numberPlayers').change(function()
        {
            var numberPlayers = $('#numberPlayers').val();
            var contenu = '<div class="form-group">';
            for(var i=0;i<numberPlayers;i++)
            {
                contenu+='<label>IA Joueur '+(i+1)+'<select class="playersIA"><option value="0">Random</option><option value="1">Aggressive</option></select></label><br>'
            }
            contenu+='</div>';
            $('#players').html(contenu);
        });


        function request()
        {
            var playersIA="";
            var url = $('#servAddress').val();
            var selectsIA = document.getElementsByClassName('playersIA');
            for(var i=0;i<selectsIA.length;i++)
            {
                playersIA+=parseInt(selectsIA[i].selectedOptions[0].value);
            }
            $.ajax({
                url:url+'init',
                type:'POST',
                crossDomain : true,
                data : {playersIA : playersIA},
                dataType:'json',
                success:function(data)
                {
                    oldPlayers = data['players'];
                    players = data['players'];
                    board = data['board'];
                    display();
                    setTimeout(motor,1000);
                }
            })
        }
        function motor()
        {
            //Appel ajax beat
            var url = $('#servAddress').val();
            $.ajax({
                url:url+'beat',
                type:'GET',
                dataType:'json',
                success:function(data)
                {
                    oldPlayers = players;
                    players = data['list'];
                    var gameOver = false;
                    if(gameOver)
                    {
                        display();
                        setTimeout(motor,1000);
                    }
                    else 
                    {
                        $.ajax({
                            url:'{{ path('game_over') }}',
                            type:'POST',
                            data:{players : players,bombs:bombsDropped}
                        })
                    }
                }
            });
        }

        function display()
        {
            var occupants = getNumberOfOccupants();
            var contenu = '<table id="map" border="0" cellspacing="0" cellpadding="0">';
            for(var i=0;i<board.length;i++)
            {
                contenu+='<tr>';
                for(var j=0;j<board[i].length;j++)
                {
                    contenu+='<td>';
                    if(board[i][j] == "x")
                    {
                        contenu+='<img id="block" src="img/wall.png">';
                    }
                    else
                    {
                        var filled = false;
                        for(var n=0;n<occupants.length;n++)
                        {
                            if(i==occupants[n][0] && j==occupants[n][1])
                            {
                                filled = true;
                                contenu+='<div style="position: relative; left: 0; top: 0;">';
                                contenu+='<img id="block" src="img/grass.png" style="position: relative; top: 0; left: 0;z-index:1;"/>';
                                contenu+='<img src="img/betty.png" id="betty" style="position: absolute; top: 8px; left: 8px;z-index:2">';

                                switch(occupants[n][2])
                                {
                                    case 1:
                                        contenu+='<img src="img/betty.png" id="betty" style="position: absolute; top: 8px; left: 8px;z-index:2">';
                                        break;
                                    case 2:
                                        contenu+='<img src="img/betty.png" id="betty" style="position: absolute; top: 8px; left: 2px;z-index:2">';
                                        contenu+='<img src="img/betty.png" id="betty" style="position: absolute; top: 8px; left: 14px;z-index:3">';
                                        break;
                                    case 3:
                                        contenu+='<img src="img/betty.png" id="betty" style="position: absolute; top: 2px; left: 8px;z-index:2">';
                                        contenu+='<img src="img/betty.png" id="betty" style="position: absolute; top: 14px; left: 2px;z-index:3">';
                                        contenu+='<img src="img/betty.png" id="betty" style="position: absolute; top: 14px; left: 14px;z-index:4">';
                                        break;
                                    case 4:
                                        contenu+='<img src="img/betty.png" id="betty" style="position: absolute; top: 2px; left: 2px;z-index:2">';
                                        contenu+='<img src="img/betty.png" id="betty" style="position: absolute; top: 14px; left: 14px;z-index:3">';
                                        contenu+='<img src="img/betty.png" id="betty" style="position: absolute; top: 14px; left: 2px;z-index:4">';
                                        contenu+='<img src="img/betty.png" id="betty" style="position: absolute; top: 2px; left: 14px;z-index:5">';
                                        break;
                                }

                                contenu+='</div>';
                            }
                        }
                        if(!filled)
                        {
                            contenu+='<img id="block" src="img/grass.png">';
                        }
                    }

                    contenu+='</td>';
                }
                contenu+='</tr>';
            }
            contenu+='</table>';
            $("#result").html(contenu);

        }

        function getNumberOfOccupants()
        {
            var occupants = new Array();
            var moreThanOne = false;
            var index = 0;
            for(var i=0;i<players.length;i++)
            {
                moreThanOne=false;
                var numberOccupants = 0;
                for(var j=0;j<players.length;j++)
                {
                    if(players[i][0]==players[j][0] && players[i][1]==players[j][1])
                    {
                        occupants[i]=[players[j][0],players[j][1],++numberOccupants];
                        moreThanOne=true;
                    }
                }
                if(!moreThanOne)
                {
                    occupants[i]=[players[j][0],players[j][1],numberOccupants]
                }
            }
            for(i=0;i<occupants.length;i++)
            {
                for(j=0;j<occupants.length;j++)
                {
                    if(occupants[i][0]==occupants[j][0] && occupants[i][1]==occupants[j][1] && occupants[i][2]==occupants[j][2] && i!=j)
                    {
                        occupants.splice(j,1);
                    }
                }
            }
            return occupants;
        }

    </script>
    </body>
    </html>

{% endblock %}

{% block stylesheets %}
<style>
    body { background: #F5F5F5; font: 18px/1.5 sans-serif; }
    h1, h2 { line-height: 1.2; margin: 0 0 .5em; }
    h1 { font-size: 36px; }
    h2 { font-size: 21px; margin-bottom: 1em; }
    p { margin: 0 0 1em 0; }
    a { color: #0000F0; }
    a:hover { text-decoration: none; }
    code { background: #F5F5F5; max-width: 100px; padding: 2px 6px; word-wrap: break-word; }
    #wrapper { background: #FFF; margin: 1em auto; max-width: 800px; width: 95%; }
    #container { padding: 2em; }
    #welcome, #status { margin-bottom: 2em; }
    #welcome h1 span { display: block; font-size: 75%; }
    #icon-status, #icon-book { float: left; height: 64px; margin-right: 1em; margin-top: -4px; width: 64px; }
    #icon-book { display: none; }

    @media (min-width: 768px) {
        #wrapper { width: 80%; margin: 2em auto; }
        #icon-book { display: inline-block; }
        #status a, #next a { display: block; }

        @-webkit-keyframes fade-in { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes fade-in { 0% { opacity: 0; } 100% { opacity: 1; } }
        .sf-toolbar { opacity: 0; -webkit-animation: fade-in 1s .2s forwards; animation: fade-in 1s .2s forwards;}
    }
</style>
{% endblock %}
