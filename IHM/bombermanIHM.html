<!DOCTYPE html>
<html>
    <head>
        <title>Bomberman</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" href="css/style.css">
        <script src="js/jquery.js"></script>
        <script src="js/ajax.js"></script>
        <script src="js/game.js"></script>
        
    </head>
    <body>
        <h1>Bomberman</h1>
		<div style="margin: auto;width:400px">
		<label>Server address<input type="textaera" id="servAddress"></label><br>
        <label>Nombre de joueurs<input type="number" id="numberPlayers"></label><br>
        <div id="players">
            
        </div>
            
		<input type="button" onClick="request()" value="Lancer le jeu"/>
        </div>
		<div id="result">-</div>

        <script>
            var players = [];
            var oldPlayers = [];
            var board = [];
            
            $('#numberPlayers').change(function()
            {
                var numberPlayers = $('#numberPlayers').val();
                var contenu = '<div>';
                for(var i=0;i<numberPlayers;i++)
                {
                    contenu+='<label>IA Joueur '+(i+1)+'<select class="playersIA"><option value="0">Random</option><option value="1">Aggressive</option></select></label><br>'
                }
                contenu+='</div>';
                $('#players').html(contenu);
            });
            
            
			function request()
			{
                var playersIA="";
                var url = $('#servAddress').val();
                var selectsIA = document.getElementsByClassName('playersIA');
                for(var i=0;i<selectsIA.length;i++)
                {
                    playersIA+=parseInt(selectsIA[i].selectedOptions[0].value);
                }
                $.ajax({
                    url:url+'init',
                    type:'POST',
                    crossDomain : true,
                    data : {playersIA : playersIA},
                    dataType:'json',
                    success:function(data)
                    {
                        oldPlayers = data['players'];
                        players = data['players'];
                        board = data['board'];
                        display();
                        setTimeout(motor,1000);
                    }
                })
            }
            function motor()
            {
                //Appel ajax beat
                var url = $('#servAddress').val();
                $.ajax({
                    url:url+'beat',
                    type:'GET',
                    dataType:'json',
                    success:function(data)
                    {
                        oldPlayers = players;
                        players = data['list'];
                        console.log(players);
                    }
                });
                display();
                setTimeout(motor,1000);
            }
            
            function display()
            {
                var contenu = '<table id="map">';
                for(var i=0;i<board.length;i++)
                {
                    contenu+='<tr>';
                    for(var j=0;j<board[i].length;j++)
                    {
                        contenu+='<td>';
                        if(board[i][j] == "x")
                        {
                            contenu+='<img id="block" src="img/wall.png">'
                        }
                        else
                        {
                            var occupied = false;
                            var filled = false;
                            for(var n=0;n<players.length;n++)
                            {
                                if(i==players[n][0] && j==players[n][1] && !occupied)
                                {
                                    contenu+='<div style="position: relative; left: 0; top: 0;">';
                                    contenu+='<img id="block" src="img/grass.png" style="position: relative; top: 0; left: 0;z-index:1;"/>';
                                    contenu+='<img src="img/betty.png" id="betty" style="position: absolute; top: 8px; left: 8px;z-index:2">';
                                    contenu+='</div>';
                                    filled=true;
                                    occupied=true;
                                }
                            }
                            if(!filled)
                            {
                                contenu+='<img id="block" src="img/grass.png">';
                            }
                        }

                        contenu+='</td>';
                    }
                    contenu+='</tr>';
                }
                contenu+='</table>';
                $("#result").html(contenu);
            }
			         
        </script>
    </body>
</html>
